<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{index :: head}">
    <meta charset="UTF-8">
    <title>Formulário</title>
</head>
<body>
<div th:replace="~{index :: sidebar}"></div>

<div class="main-content">
    <div class="container">
        <h2 class="mb-4" th:text="${usuario.id == null} ? 'Cadastrar Usuário' : 'Editar Usuário'"></h2>

        <div th:if="${erroGeral != null}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <strong th:text="${erroGeral}"></strong>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <form th:action="@{/usuarios}" method="post" class="row g-3 needs-validation" novalidate>

            <input type="hidden" name="id" th:value="${usuario.id}"/>

            <div class="col-md-6">
                <label for="nome" class="form-label">Nome</label>
                <input type="text" class="form-control" id="nome" name="nome" th:value="${usuario.nome}" required>
                <div class="invalid-feedback">Por favor, preencha o nome.</div>
            </div>

            <div class="col-md-6"> <label for="email" class="form-label">E-mail</label>
                <input type="email" class="form-control" id="email" name="email" th:value="${usuario.email}" required>
                <div class="invalid-feedback">E-mail inválido.</div>
            </div>

            <div class="col-md-6"> <label for="cpf" class="form-label">CPF</label>
                <input type="text" class="form-control" id="cpf" name="cpf" th:value="${usuario.cpf}" required maxlength="11">
                <div class="invalid-feedback">Preencha o CPF.</div>
            </div>

            <div class="col-md-6">
                <label for="telefone" class="form-label">Telefone</label>
                <input type="text" class="form-control" id="telefone" name="telefone" th:value="${usuario.telefone}">
            </div>

            <div class="col-md-6">
                <label for="senha" class="form-label">Senha</label>

                <input type="password" class="form-control" id="senha" name="senha"
                       th:value="${usuario.senha}"
                       placeholder="Digite a senha"
                       th:if="${usuario.id == null}" required />

                <input type="password" class="form-control" id="senha" name="senha"
                       placeholder="Deixe em branco para manter a atual"
                       th:unless="${usuario.id == null}" />
            </div>

            <div class="col-md-6">
                <label for="tipoUsuario" class="form-label">Tipo de Usuário</label>
                <select class="form-select" id="tipoUsuario" name="tipoUsuario.id" onchange="verificarTipoUsuario()" required>
                    <option disabled selected value="">Selecione...</option>
                    <option th:each="tipo : ${tipos}"
                            th:value="${tipo.id}"
                            th:text="${tipo.descricao}"
                            th:selected="${usuario.tipoUsuario != null and usuario.tipoUsuario.id == tipo.id}">
                    </option>
                </select>
                <div class="invalid-feedback">Selecione um tipo.</div>
            </div>

            <div id="areaResponsavel" class="row g-3 border-top mt-4 pt-3 d-none">
                <h4 class="mb-3">Dados do Responsável</h4>

                <input type="hidden" name="respId" th:value="${responsavel.id}">

                <div class="col-md-6">
                    <label for="respNome" class="form-label">Nome do Responsável</label>
                    <input type="text" class="form-control resp-field" id="respNome" name="respNome" th:value="${responsavel.nome}">
                    <div class="invalid-feedback">Nome do responsável é obrigatório.</div>
                </div>

                <div class="col-md-6">
                    <label for="respCpf" class="form-label">CPF do Responsável</label>
                    <input type="text" class="form-control resp-field" id="respCpf" name="respCpf" th:value="${responsavel.cpf}" maxlength="11">
                    <div class="invalid-feedback">CPF do responsável é obrigatório.</div>
                </div>

                <div class="col-md-6">
                    <label for="respTelefone" class="form-label">Telefone do Responsável</label>
                    <input type="text" class="form-control resp-field" id="respTelefone" name="respTelefone" th:value="${responsavel.telefone}">
                    <div class="invalid-feedback">Telefone do responsável é obrigatório.</div>
                </div>

                <div class="col-md-6">
                    <label for="respEmail" class="form-label">E-mail do Responsável</label>
                    <input type="email" class="form-control resp-field" id="respEmail" name="respEmail" th:value="${responsavel.email}">
                    <div class="invalid-feedback">E-mail do responsável é obrigatório.</div>
                </div>
            </div>

            <div class="col-12 mt-4">
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-save"></i> Salvar
                </button>
                <a href="/usuarios" class="btn btn-secondary">Cancelar</a>
            </div>
        </form>
    </div>
</div>

<script>
    function verificarTipoUsuario() {
        const select = document.getElementById('tipoUsuario');
        const areaResponsavel = document.getElementById('areaResponsavel');
        const camposResponsavel = document.querySelectorAll('.resp-field');

        // Verifica se o texto da opção selecionada contém "Aluno"
        const textoSelecionado = select.options[select.selectedIndex].text;

        if (textoSelecionado.toLowerCase().includes('aluno')) {
            areaResponsavel.classList.remove('d-none');
            camposResponsavel.forEach(campo => campo.setAttribute('required', 'required'));
        } else {
            areaResponsavel.classList.add('d-none');
            camposResponsavel.forEach(campo => campo.removeAttribute('required'));
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        verificarTipoUsuario();
    });

    (function () {
        'use strict';
        var forms = document.querySelectorAll('.needs-validation');
        Array.prototype.slice.call(forms)
            .forEach(function (form) {
                form.addEventListener('submit', function (event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
    })();
</script>
<script th:src="@{/js/sidebar-toggle.js}"></script>
</body>
</html>