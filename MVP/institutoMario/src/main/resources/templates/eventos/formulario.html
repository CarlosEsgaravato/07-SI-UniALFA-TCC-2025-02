<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{index :: head}">
  <title>Cadastro de Evento</title>
</head>
<body>

<div th:replace="~{index :: sidebar}"></div>

<div class="main-content">
  <h2 th:text="${evento.id == null} ? 'Novo Evento' : 'Editar Evento'"></h2>

  <form th:action="@{/eventos/salvar}" th:object="${evento}" method="post" enctype="multipart/form-data" class="mt-4" onsubmit="return validarData();">
    <input type="hidden" th:field="*{id}"/>
    <input type="hidden" th:field="*{imagemUrl}"/>

    <div class="row">
      <div class="col-md-8 mb-3">
        <label class="form-label" for="nomeEvento">Nome do Evento</label>
        <input class="form-control" id="nomeEvento" th:field="*{nomeEvento}" required/>
      </div>
      <div class="col-md-4 mb-3">
        <label class="form-label" for="data">Data e Hora</label>
        <input type="datetime-local" class="form-control" id="data" name="data"
               th:value="${evento.data != null ? #temporals.format(evento.data, 'yyyy-MM-dd''T''HH:mm') : ''}" required />
      </div>
    </div>
    <div class="row">
      <div class="col-md-6 mb-3">
        <label class="form-label" for="local">Local</label>
        <input class="form-control" id="local" th:field="*{local}"/>
      </div>
      <div class="col-md-6 mb-3">
        <label class="form-label" for="turma">Turma (Opcional)</label>
        <select class="form-select" id="turma" th:field="*{turma.id}"><option selected value="">Geral</option><option th:each="t : ${turmas}" th:value="${t.id}" th:text="${t.nome}"></option></select>
      </div>
    </div>
    <div class="mb-3">
      <label class="form-label" for="observacao">Observação</label>
      <textarea class="form-control" id="observacao" th:field="*{observacao}" rows="3"></textarea>
    </div>

    <div class="mb-3">
      <label for="imagemFile" class="form-label">Imagem do Evento</label>
      <input class="form-control" type="file" id="imagemFile" name="imagemFile" accept="image/png, image/jpeg, image/jpg">
    </div>

      <div class="mb-3" th:if="${evento.id != null and evento.imagemUrl != null}">
          <label class="form-label">Imagem Atual: *Faça upload de uma nova imagem caso deseje substituir a atual*</label><br>
          <img th:src="@{/uploads/{filename}(filename=${evento.imagemUrl})}" alt="Imagem do Evento" style="max-width: 200px; max-height: 200px; border-radius: 8px;">
      </div>

    <button type="submit" class="btn btn-success"><i class="bi bi-save"></i> Salvar</button>
    <a th:href="@{/eventos}" class="btn btn-secondary ms-2">Cancelar</a>
  </form>
</div>

<script>
    let conflitoVerificado = false; // Flag para evitar loop de confirmação

    async function validarData() {
        const campoData = document.getElementById('data');
        const idCampo = document.getElementById('id');
        const dataSelecionadaStr = campoData.value;

        // 1. Validação de Campo Vazio
        if (!dataSelecionadaStr) {
            return true;
        }

        const dataSelecionada = new Date(dataSelecionadaStr);
        const agora = new Date();
        agora.setSeconds(0, 0);

        // 2. Validação de Data no Passado
        if (dataSelecionada < agora) {
            if (!confirm('A data e hora do evento estão no passado. Deseja realmente salvar?')) {
                return false;
            }
        }

        // Se o conflito já foi verificado e o usuário confirmou, prossegue.
        if (conflitoVerificado) {
            return true;
        }

        // 3. Validação de Conflito de Horário (AJAX)

        // Obter o ID do evento (será null para novo cadastro)
        // O campo hidden tem 'id' no Spring: <input type="hidden" th:field="*{id}"/>
        const idEvento = idCampo ? idCampo.value : '';

        // Montar a URL de verificação
        // Adicionamos :00.000 para consistência com o formato ISO do Spring, se necessário.
        // Assumimos que o campo data é enviado como yyyy-MM-dd'T'HH:mm (padrão datetime-local)
        const urlVerificacao = `/eventos/verificarHorario?dataHora=${dataSelecionadaStr}&idEvento=${idEvento}`;

        try {
            const response = await fetch(urlVerificacao);
            const existeConflito = await response.json(); // Recebe true ou false do backend

            if (existeConflito) {
                // Existe um evento no mesmo horário, exibir alerta de confirmação.
                if (confirm('ATENÇÃO: Já existe outro evento cadastrado neste mesmo horário. Deseja realmente salvar assim mesmo?')) {
                    // Se o usuário confirmar, marca a flag e submete o formulário novamente.
                    conflitoVerificado = true;
                    // Submete o formulário programaticamente (a primeira tentativa foi parada pelo 'onsubmit')
                    document.querySelector('form').submit();
                    return false; // Retorna false na primeira vez, a submissão ocorrerá pela linha acima.
                } else {
                    // Usuário cancelou
                    return false;
                }
            } else {
                return true;
            }
        } catch (error) {
            console.error('Erro na verificação de horário:', error);
            alert('Não foi possível verificar a disponibilidade de horário. Tente novamente.');
            return false; // Bloqueia o salvamento em caso de erro na comunicação.
        }
    }
</script>

</body>
</html>